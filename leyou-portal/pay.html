<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
	<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
	<title>乐优商城--支付页</title>
	<link rel="icon" href="/assets/img/favicon.ico">
	<link rel="stylesheet" type="text/css" href="css/webbase.css" />
	<link rel="stylesheet" type="text/css" href="css/pages-weixinpay.css" />
</head>
<body>
<div id="payVm">
	<div class="top">
		<shortcut />
	</div>
	<div class="cart py-container">
		<!--logoArea-->
		<div class="logoArea">
			<div class="fl logo"><span class="title">收银台</span></div>
		</div>
		<!--主内容-->

		<a href="payfail.html">支付失败演示页</a>
		<a href="paysuccess.html">支付成功演示页</a>


		<div class="checkout py-container pay">
			<div class="checkout-tit">
				<h4 class="fl tit-txt"><span class="success-icon"></span><span  class="success-info">订单提交成功，请您及时付款！订单号：{{orderId}}</span></h4>
				<span class="fr"><em class="sui-lead">应付金额：</em><em  class="orange money">￥{{ly.formatPrice(totalPay)}}</em>元</span>
				<div class="clearfix"></div>
			</div>
			<div class="checkout-steps">
				<div class="fl weixin">支付宝支付</div>
				<div class="fl sao">
					<p class="red">二维码有效时间为2小时，请及时支付</p>
					<div class="fl code">
						<h3 class="fl tit-txt"><span class="success-icon"></span><span  class="success-info">页面将在<span class="red timer">{{timer}}秒</span>钟之后跳转到支付页面</span></h3>
					</div>
				</div>
				<div class="clearfix"></div>
				<div ref="pageForward"></div>
			</div>
		</div>

	</div>
</div>
<script src="./js/vue/vue.js"></script>
<script src="./js/axios.min.js"></script>
<script src="./js/common.js"></script>
<script src="./js/qrcode.min.js"></script>
<script type="text/javascript">
	var payVm = new Vue({
		el:"#payVm",
		data:{
			ly,
			orderId:0, //订单id
			totalPay:0, //总金额
			timer:5
		},
		components:{
			shortcut: () => import("/js/pages/shortcut.js")
		},
		created(){
			this.loadData();
		},
		methods:{
			loadData(){
				//1.判断用户是否登录
				ly.verifyUser().then(() => {
					//2.获取订单编号和总金额
					this.orderId = ly.store.get("orderId");
					this.totalPay = ly.store.get("totalPay");
					const forwardTimer = setInterval(()=>{
						if(this.timer<=1){
							clearInterval(forwardTimer);
							// 发送请求生成支付订单，拿到返回结果，将返回结果用dom添加到文档中
							ly.http.post("/order/pay/"+this.orderId).then(resp=>{
								// 删除本地存储中的订单号
								ly.store.del("orderId");
								// 将页面跳转脚本嵌入其中
								this.$refs.pageForward.innerHTML=resp.data;
								document.getElementsByName("punchout_form")[0].submit();
							}).catch(()=>{
								alert("系统繁忙！请稍后再试！")
							})
						}else {
							this.timer--;
						}
					},1000);
					//3.获取请求链接
					// ly.http.get("/order/url/" + this.orderId).then(resp => {
					// 	//3.2开启定时任务，查询付款状态
					// 	const taskId = setInterval(() => {
					// 		ly.http.get("/order/state" + this.orderId).then(resp => {
					// 			let i = resp.data;
					// 			if (i === 1){
					// 				//3.3 付款成功
					// 				clearInterval(taskId);
					// 				//3.4 跳转到付款成功页
					// 				location.href = "/paysuccess.html";
					// 				//3.5 删除本地存储中的订单号
					// 				ly.store.del("orderId");
					// 			} else if (i === 2){
					// 				//3.5付款失败
					// 				clearInterval(taskId);
					// 				//3.6跳转到付款失败页
					// 				location.href = "/payfail.html"
					// 			}
					// 		})
					// 	},1000);
					// });
				}).catch(() => {
					//4.未登录，跳转至登录页
					location.href = "/login.html?returnUrl=" + location.href;
				})
			}
		}
	});
</script>
<!-- 底部栏位 -->
<!--页面底部，由js动态加载-->
<div class="clearfix footer"></div>
<script type="text/javascript" src="js/plugins/jquery/jquery.min.js"></script>
<script type="text/javascript">$(".footer").load("foot.html");</script>
<!--页面底部END-->
<script type="text/javascript" src="js/plugins/jquery.easing/jquery.easing.min.js"></script>
<script type="text/javascript" src="js/plugins/sui/sui.min.js"></script>
<script type="text/javascript" src="js/widget/nav.js"></script>
<script type="text/javascript">
	$(function(){
		$("ul.payType li").click(function(){
			$(this).css("border","2px solid #E4393C").siblings().css("border-color","#ddd");
		})
	})
</script>
</body>

</html>